 # 基于STM32F103C8T6的PS2手柄控制麦轮小车开发文档

## 一、 GPIO与PWM基础驱动开发（10.3-10.10）
###  功能描述与开发历程

实现GPIO基础输入输出控制及PWM信号生成，为后续电机和舵机控制奠定硬件基础。
#### 开发历程
1. 在项目初期，我们首先需要掌握STM32F103C8T6的基础外设控制能力。选择GPIO和PWM作为切入点是因为它们是机器人运动控制的核心基础。
2. 通过战队培训，学习了：
     a.通过gpio控制引脚高低电平，从而控制led小灯。
     b.pwm占空比的重要性以及本质，占空比的实质为一个pwm周期中高电平时间占一个周期时间的比例。
     c.pwm控制输出电压。通过控制不同的占空比就可以实现输出不同电压，我电控组认为，这类似于此前所接触的等效电压，我们用此帮助理解pwm。


#### 关键难点
PWM频率精度问题：初期测试发现PWM频率存在偏差，通过分析系统时钟树发现分频设置错误，在编程时arr设置错误。

#### 解决方案：

1. 优化系统时钟配置。
2. 精确计算定时器分频值。
3. 深入理解占空比，理解arr与crr之间关系对占空比的影响，调节arr的值。

###  迭代优化

1. 基础GPIO控制LED闪烁，而后通过pwm实现亮灯以相反的方式进行呼吸灯操作，验证开发环境。
2. 实现PWM控制舵机角度，通过计算占空比，能够完成0°-180°转动精确控制。
3. 通过控制pwm输出电压增减，实现tt马达正反转和速度调节。


## 二、Fusion的使用（10.4-10.11）

### 功能描述与开发历程

学习了如何使用Fusion进行机械设计和建模，将设计思想具体化，并通过三维图形与电控组进行有效沟通，并检验可行性。学习了3d打印应用：学会了如何使用3D打印机。学习了部分机械设计相关的知识。

### 关键难点

对机器人系统的整体工作原理并不熟悉，尤其是在如何将各个部分（如电控、运动学和机械结构）整合为一个有机整体的方面存在较大困难。

### 解决方案

学习机械设计，与小队内各组进行适当的沟通。



## 三、 SPI通信与PS2手柄控制（10.11-10.14）
###  功能描述与开发历程

通过SPI接口与PS2手柄接收器通信，实现远程控制功能，并将控制数据解析为机器人运动指令。




## 四、 麦克纳姆轮运动学解算及其ps2控制小车编程（10.15-10.20）

### 功能描述

使用麦克纳姆轮实现车辆全向移动，将PS2手柄的控制输入转换为四个麦轮的电机的转速和方向控制。

### 开发历程

麦克纳姆轮的运动控制是项目中最具挑战性的部分之一。我们首先从理论分析开始，对AB麦轮分别进行受力分析，得出AB单个麦轮向前后运动时的受力状况，再根据我们对麦轮实现前后左右以及平行移动的需求进行了受力分析与速度合成，建立了完整的运动学模型，并运用此前的pwm知识实现输出不同方向电流使得麦轮能够按照设想旋转。最后运用证明，确可达到全向运动的要求。

### 运动学原理分析

麦克纳姆轮由主轮以及小的滚轴构成，当它滚动时，除了具有主轮方向的速度，还具有垂直于滚轴的速度，两速度合成能够发现，平日里轮子向前滚动向前运动与麦轮完全不同，它会斜向运动（X平移、Y平移、旋转）。

### 关键难点
麦轮的受力分析，运动的解算。

### 解决方案
1. 通过对麦轮进行细致的受力分析，能够实现对麦轮的编程。
2. 对每个电机进行精确校准，建立PWM占空比与实际转速的关系。



## 五、车体的设计（设计时为通用部分，功能模块可替换）（10.15-10.23）

### 功能描述


本阶段主要实现了小车车体的设计和构建，为后续电控部分提供机械支持。车体结构需要考虑到小车的稳定性、重量分布、长度控制以及电控系统的安装需求。
1. 首先是车底盘，车底盘主要安装tt马达与麦轮（计划利用底盘空余空间设计一个载球仓，还未打印）。
2. 第一层主要存放小球以及小球存储装置，小球收集装置（详见下文五）。
3. 第二层为小车的控制层，存放有一块面包板，一个stm32,两个l298n（与底层tt马达相连），一个电池盒，ps2接收器。

### 开发历程

1. 起初按照旧规则进行设计，后因更改车长改变作废。
2. 新底盘公布后，我们做出了如下设想：
    a.设计三层，一层存放控制设备，两层用于存储小球；。
    b.设计两层，第二层存放控制设备，第一层与底盘（弥补容量不足）作为存储空间。
3. 后因时间因素以及材料获取时间，我们选择了两层方案，设计出了通用底盘，便于后续进行功能模块替换。

### 关键难点

主要是组内对于控制模块以及存储装置布局的分歧以及空间小带来的模块安装问题。难以兼顾存储模块以及控制模块，认为控制的安装必定会干扰存储部分。

### 解决方案

因队员位于不同校区，我们采取“队长两方沟通”+“qq线上会议”+“空闲全队线下讨论”的方式，充分表达各自意见，最后做出了设计上述通用底盘的决定。

### 迭代优化

初期设计了较简单的车体模型，但随着系统功能逐步增多，我们在原有设计的基础上对车体进行了多次修改。根据电控组的需求调整了控制设备存放区域的空间，确保了电池盒、STM32、L298N等组件的合理布置。经过多次组装测试，优化了车体各部件之间的配合度，确保了车体的组装更加精确。


## 六、 球体收集机构设计与控制（10.18-10.25）

### 功能描述

灵感来源于推土机。在车体第一层前端安装一个SG90舵机，连接第二层stm32的一个pwm接口，通过控制pwm占空比能够通过舵机使铲头旋转正确的角度，通过铲头初步将小球收集入铲斗，同时凭借铲斗特殊的锯齿设计能有效减少小球滑落的情况。当小球平稳进入铲斗后，控制舵机旋转一定角度使铲斗中的小球落入收集装置中。

### 开发历程

1. 我们遇到了起初毫无思路的难题，主要是如何将小球从收集装置转移到储存装置中。
2. 而后通过思考我们得出了三个备选方案：
      a.使用铲斗。以推土机的形式将小球收集，再通过铲斗旋转转移小球至储存容器中。
      b.水车方案。制作一个水车类似物，通过tt马达带动其旋转，在旋转中将小球卷入储存装置中。
      c.吸尘器方案。利用高速马达，制造一个吸尘器类似物，通过吸力将小球吸入储存装置。
3. 后因配件到货时间晚等原因，选择了实现难度较低的”铲斗“方案。电控组进行舵机转动角度的编程，机械组着手铲斗及储存装置的建模，而后通过3d打印获得零部件并进行安装，最后经测试，该方案能够收集小球。

### 关键难点

如何确保球体顺利转移铲斗设计中。

### 解决方案

我们采用了锯齿形状来减少球体滑落，并通过舵机精确控制铲斗的角度，保证每次转移小球时的准确性。



### 可能的更改

在中期考核后，可能会使用到货配件将另一辆车按照“吸尘器”方案装配。






## 七、 总结
通过这个项目，我们完整地经历了从零开始开发一个复杂嵌入式系统的全过程。从最基础的GPIO控制到复杂的运动学算法，从简单建模到复杂的车辆设计，每一个阶段都遇到了不同的挑战，也收获了宝贵的经验。

### 技术收获：

1. 初步理解了STM32系列微控制器的架构和外设编程
2. 学习并实践了编写一套麦轮运动算法，能够编写基础的小车控制系统。
3. 对建模有了初步了解，能够运用fusion进行简单设计，并通过3d打印实现。
4. 培养了对嵌入式学习，机械设计及制造的兴趣，对嵌入式和机械只是有了自己主观的感受，虽然遇到挫折时也会难受，但仍在小车跑起来时无比兴奋。
